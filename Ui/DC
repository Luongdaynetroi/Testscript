--[[
    DClib - Dac Cau Library
    Roblox UI Library với rounded design
]]

local Players = game:GetService("Players")
local TweenService = game:GetService("TweenService")
local UserInputService = game:GetService("UserInputService")
local CoreGui = game:GetService("CoreGui")
local RunService = game:GetService("RunService")

local Player = Players.LocalPlayer

local DClib = {}

-- Theme đẹp hơn
DClib.Theme = "Purple"
DClib.Themes = {
    Purple = {
        Background = ColorSequence.new({
            ColorSequenceKeypoint.new(0, Color3.fromRGB(60, 30, 80)),
            ColorSequenceKeypoint.new(1, Color3.fromRGB(45, 20, 60))
        }),
        BackgroundSolid = Color3.fromRGB(55, 25, 70),
        Stroke = Color3.fromRGB(100, 60, 130),
        Text = Color3.fromRGB(255, 255, 255),
        Text2 = Color3.fromRGB(200, 180, 220),
        Accent = Color3.fromRGB(180, 100, 255),
        AccentHover = Color3.fromRGB(210, 130, 255)
    }
}

-- Helper function
local function Create(instanceType, properties)
    local instance = Instance.new(instanceType)
    for prop, value in pairs(properties or {}) do
        instance[prop] = value
    end
    return instance
end

local function MakeCorner(parent, radius)
    local corner = Create("UICorner", {
        Parent = parent,
        CornerRadius = UDim.new(0, radius or 8)
    })
    return corner
end

local function MakeStroke(parent, color, thickness)
    local stroke = Create("UIStroke", {
        Parent = parent,
        Color = color or DClib.Themes[DClib.Theme].Stroke,
        Thickness = thickness or 1
    })
    return stroke
end

local function Tween(instance, properties, duration)
    local tweenInfo = TweenInfo.new(duration or 0.3, Enum.EasingStyle.Quad, Enum.EasingDirection.Out)
    local tween = TweenService:Create(instance, tweenInfo, properties)
    tween:Play()
    return tween
end

local function QuickTween(instance, properties)
    local tweenInfo = TweenInfo.new(0.15, Enum.EasingStyle.Sine, Enum.EasingDirection.Out)
    local tween = TweenService:Create(instance, tweenInfo, properties)
    tween:Play()
    return tween
end

-- MakeWindow function
function DClib:MakeWindow(config)
    local name = config.Name or "DClib"
    local subtitle = config.SubTitle or ""
    
    -- ScreenGui
    local ScreenGui = Create("ScreenGui", {
        Name = "DClib_ScreenGui",
        Parent = RunService:IsClient() and CoreGui or Player:WaitForChild("PlayerGui"),
        ResetOnSpawn = false,
        IgnoreGuiInset = true
    })
    
    -- Main Frame (HÌNH TRÒN HOÀN TOÀN)
    local MainFrame = Create("Frame", {
        Name = "MainFrame",
        Parent = ScreenGui,
        Size = UDim2.new(0, 420, 0, 420),
        Position = UDim2.new(0.5, -210, 0.5, -210),
        BackgroundColor3 = DClib.Themes[DClib.Theme].BackgroundSolid,
        BorderSizePixel = 0
    })
    
    -- Gradient background
    local Gradient = Create("UIGradient", {
        Parent = MainFrame,
        Color = DClib.Themes[DClib.Theme].Background,
        Rotation = 45
    })
    
    -- BO TRÒN HOÀN TOÀN (corner radius lớn)
    MakeCorner(MainFrame, 210) -- Lớn hơn size để thành hình tròn
    MakeStroke(MainFrame, DClib.Themes[DClib.Theme].Stroke, 2)
    
    -- Title Bar
    local TitleBar = Create("Frame", {
        Name = "TitleBar",
        Parent = MainFrame,
        Size = UDim2.new(1, 0, 0, 35),
        BackgroundTransparency = 1
    })
    
    -- Title Label
    local TitleLabel = Create("TextLabel", {
        Name = "Title",
        Parent = TitleBar,
        Size = UDim2.new(1, -70, 1, 0),
        Position = UDim2.new(0, 10, 0, 0),
        BackgroundTransparency = 1,
        Text = name,
        TextColor3 = DClib.Themes[DClib.Theme].Text,
        TextXAlignment = "Left",
        Font = Enum.Font.GothamBold,
        TextSize = 14
    })
    
    -- SubTitle Label
    local SubTitleLabel = Create("TextLabel", {
        Name = "SubTitle",
        Parent = TitleBar,
        Size = UDim2.new(1, -80, 0, 12),
        Position = UDim2.new(0, 10, 1, -12),
        BackgroundTransparency = 1,
        Text = subtitle,
        TextColor3 = DClib.Themes[DClib.Theme].Text2,
        TextXAlignment = "Left",
        Font = Enum.Font.Gotham,
        TextSize = 10
    })
    
    -- Close Button (TRÒN VỚI CORNER RADIUS 8)
    local CloseBtn = Create("ImageButton", {
        Name = "CloseButton",
        Parent = TitleBar,
        Size = UDim2.new(0, 16, 0, 16),
        Position = UDim2.new(1, -24, 0.5, -8),
        BackgroundTransparency = 1,
        Image = "rbxassetid://10747384394",
        ImageColor3 = DClib.Themes[DClib.Theme].Text2
    })
    
    CloseBtn.MouseButton1Click:Connect(function()
        Tween(MainFrame, {Size = UDim2.new(0, 0, 0, 0)}, 0.2)
        Tween(MainFrame, {Transparency = 1}, 0.2)
        task.wait(0.2)
        ScreenGui:Destroy()
    end)
    
    -- Minimize Button (TRÒN VỚI CORNER RADIUS 6)
    local MinimizeBtn = Create("ImageButton", {
        Name = "MinimizeButton",
        Parent = TitleBar,
        Size = UDim2.new(0, 16, 0, 16),
        Position = UDim2.new(1, -44, 0.5, -8),
        BackgroundTransparency = 1,
        Image = "rbxassetid://10734896206",
        ImageColor3 = DClib.Themes[DClib.Theme].Text2
    })
    
    local minimized = false
    MinimizeBtn.MouseButton1Click:Connect(function()
        if minimized then
            Tween(MainFrame, {Size = UDim2.new(0, 420, 0, 420)}, 0.4)
            Tween(MainFrame, {Position = UDim2.new(0.5, -210, 0.5, -210)}, 0.4)
            minimized = false
        else
            Tween(MainFrame, {Size = UDim2.new(0, 420, 0, 65)}, 0.4)
            Tween(MainFrame, {Position = UDim2.new(0.5, -210, 0.5, -32)}, 0.4)
            minimized = true
        end
    end)
    
    -- Tab Area (phía trên content)
    local TabArea = Create("Frame", {
        Name = "TabArea",
        Parent = MainFrame,
        Size = UDim2.new(1, -40, 0, 45),
        Position = UDim2.new(0, 20, 0, 45),
        BackgroundTransparency = 1
    })
    
    -- Tab Scroll (horizontal)
    local TabScroll = Create("ScrollingFrame", {
        Name = "TabScroll",
        Parent = TabArea,
        Size = UDim2.new(1, 0, 1, 0),
        BackgroundTransparency = 1,
        ScrollBarThickness = 0,
        ScrollingDirection = "X",
        AutomaticCanvasSize = "X"
    })
    
    local TabLayout = Create("UIListLayout", {
        Parent = TabScroll,
        Padding = UDim.new(0, 5),
        FillDirection = "Horizontal",
        VerticalAlignment = "Center",
        HorizontalAlignment = "Center"
    })
    
    -- Content Container (chứa tab panels)
    local Content = Create("Frame", {
        Name = "Content",
        Parent = MainFrame,
        Size = UDim2.new(1, -40, 1, -100),
        Position = UDim2.new(0, 20, 0, 100),
        BackgroundTransparency = 1,
        ClipsDescendants = true
    })
    
    -- Drag functionality
    local dragging = false
    local dragStart = nil
    local startPos = nil
    
    TitleBar.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            dragging = true
            dragStart = input.Position
            startPos = MainFrame.Position
            
            local conn1, conn2
            conn1 = UserInputService.InputChanged:Connect(function(input)
                if dragging and input.UserInputType == Enum.UserInputType.MouseMovement then
                    local delta = input.Position - dragStart
                    MainFrame.Position = UDim2.new(
                        startPos.X.Scale,
                        startPos.X.Offset + delta.X,
                        startPos.Y.Scale,
                        startPos.Y.Offset + delta.Y
                    )
                end
            end)
            
            conn2 = UserInputService.InputEnded:Connect(function(input)
                if input.UserInputType == Enum.UserInputType.MouseButton1 then
                    dragging = false
                    conn1:Disconnect()
                    conn2:Disconnect()
                end
            end)
        end
    end)
    
    -- Tab storage
    local tabButtons = {}
    local tabPanels = {}
    
    -- Return Window object
    local Window = {}
    
    -- AddTab function
    function Window:AddTab(config)
        local tabName = config.Name or "Tab"
        local tabIcon = config.Icon or ""
        
        -- Tab Button (BO TRÒN)
        local TabBtn = Create("TextButton", {
            Name = "TabBtn_" .. tabName,
            Parent = TabScroll,
            Size = UDim2.new(0, 65, 0, 28),
            BackgroundColor3 = Color3.fromRGB(80, 50, 100),
            Text = "",
            AutoButtonColor = true,
            BorderSizePixel = 0
        })
        
        -- Bo tròn tab button
        MakeCorner(TabBtn, 8)
        
        -- Tab icon (nếu có)
        if tabIcon ~= "" then
            local Icon = Create("ImageLabel", {
                Name = "TabIcon",
                Parent = TabBtn,
                Size = UDim2.new(0, 14, 0, 14),
                Position = UDim2.new(0.5, -7, 0.5, -7),
                BackgroundTransparency = 1,
                Image = tabIcon,
                ImageColor3 = DClib.Themes[DClib.Theme].Text
            })
        end
        
        -- Tab Label
        local TabLabel = Create("TextLabel", {
            Name = "TabLabel",
            Parent = TabBtn,
            Size = UDim2.new(1, 0, 0, 12),
            Position = UDim2.new(0, 0, 1, -12),
            BackgroundTransparency = 1,
            Text = tabName,
            TextColor3 = DClib.Themes[DClib.Theme].Text,
            TextSize = 10,
            Font = Enum.Font.GothamBold,
            TextXAlignment = "Center"
        })
        
        -- Hover effects
        TabBtn.MouseEnter:Connect(function()
            QuickTween(TabBtn, {BackgroundColor3 = DClib.Themes[DClib.Theme].Accent})
        end)
        
        TabBtn.MouseLeave:Connect(function()
            QuickTween(TabBtn, {BackgroundColor3 = Color3.fromRGB(80, 50, 100)})
        end)
        
        -- Tab Content Panel (BO TRÒN)
        local Panel = Create("Frame", {
            Name = "Panel_" .. tabName,
            Parent = Content,
            Size = UDim2.new(1, 0, 1, 0),
            Visible = false,
            BackgroundColor3 = DClib.Themes[DClib.Theme].Background,
            ClipsDescendants = true
        })
        
        MakeCorner(Panel, 8)
        MakeStroke(Panel, DClib.Themes[DClib.Theme].Stroke, 1)
        
        -- Panel Scroll
        local PanelScroll = Create("ScrollingFrame", {
            Name = "PanelScroll",
            Parent = Panel,
            Size = UDim2.new(1, -4, 1, -4),
            Position = UDim2.new(0, 2, 0, 2),
            BackgroundTransparency = 1,
            ScrollBarThickness = 4,
            ScrollBarImageColor3 = DClib.Themes[DClib.Theme].Accent,
            AutomaticCanvasSize = "Y"
        })
        
        local PanelLayout = Create("UIListLayout", {
            Parent = PanelScroll,
            Padding = UDim.new(0, 8),
            SortOrder = "LayoutOrder"
        })
        
        local PanelPadding = Create("UIPadding", {
            Parent = PanelScroll,
            PaddingLeft = UDim.new(0, 8),
            PaddingRight = UDim.new(0, 8),
            PaddingTop = UDim.new(0, 8),
            PaddingBottom = UDim.new(0, 8)
        })
        
        -- Lưu tab
        table.insert(tabButtons, TabBtn)
        table.insert(tabPanels, Panel)
        
        -- Click handler
        TabBtn.MouseButton1Click:Connect(function()
            -- Ẩn tất cả panels
            for _, p in ipairs(tabPanels) do
                p.Visible = false
            end
            -- Hiện panel này
            Panel.Visible = true
        end)
        
        -- Return Tab object
        local Tab = {}
        
        function Tab:AddSection(text)
            local Section = Create("Frame", {
                Name = "Section",
                Parent = PanelScroll,
                Size = UDim2.new(1, 0, 0, 20),
                BackgroundTransparency = 1
            })
            
            local Label = Create("TextLabel", {
                Name = "Label",
                Parent = Section,
                Size = UDim2.new(1, 0, 1, 0),
                BackgroundTransparency = 1,
                Text = text,
                TextColor3 = DClib.Themes[DClib.Theme].Text,
                TextSize = 12,
                Font = Enum.Font.GothamBold,
                TextXAlignment = "Left"
            })
            
            return Section
        end
        
        function Tab:AddButton(config)
            local btnName = config.Name or "Button"
            local callback = config.Callback or function() end
            
            local Btn = Create("TextButton", {
                Name = "Button",
                Parent = PanelScroll,
                Size = UDim2.new(1, 0, 0, 38),
                BackgroundColor3 = DClib.Themes[DClib.Theme].Accent,
                Text = "",
                AutoButtonColor = true,
                BorderSizePixel = 0
            })
            
            MakeCorner(Btn, 10)
            
            local Label = Create("TextLabel", {
                Name = "Label",
                Parent = Btn,
                Size = UDim2.new(1, -20, 1, 0),
                Position = UDim2.new(0, 15, 0, 0),
                BackgroundTransparency = 1,
                Text = btnName,
                TextColor3 = Color3.fromRGB(255, 255, 255),
                TextSize = 13,
                Font = Enum.Font.GothamBold,
                TextXAlignment = "Left"
            })
            
            -- Shine effect
            local Shine = Create("ImageLabel", {
                Name = "Shine",
                Parent = Btn,
                Size = UDim2.new(1, 0, 0.5, 0),
                Position = UDim2.new(0, 0, 0, 0),
                BackgroundTransparency = 1,
                Image = "rbxassetid://4912487335",
                ImageTransparency = 0.8,
                ZIndex = 2
            })
            
            Btn.MouseEnter:Connect(function()
                QuickTween(Btn, {BackgroundColor3 = DClib.Themes[DClib.Theme].AccentHover})
                QuickTween(Shine, {ImageTransparency = 0.5})
            end)
            
            Btn.MouseLeave:Connect(function()
                QuickTween(Btn, {BackgroundColor3 = DClib.Themes[DClib.Theme].Accent})
                QuickTween(Shine, {ImageTransparency = 0.8})
            end)
            
            Btn.MouseButton1Click:Connect(callback)
            
            return Btn
        end
        
        function Tab:AddToggle(config)
            local toggleName = config.Name or "Toggle"
            local default = config.Default or false
            local callback = config.Callback or function() end
            
            local Toggle = Create("Frame", {
                Name = "Toggle",
                Parent = PanelScroll,
                Size = UDim2.new(1, 0, 0, 35),
                BackgroundTransparency = 1
            })
            
            local Label = Create("TextLabel", {
                Name = "Label",
                Parent = Toggle,
                Size = UDim2.new(1, -50, 1, 0),
                BackgroundTransparency = 1,
                Text = toggleName,
                TextColor3 = DClib.Themes[DClib.Theme].Text,
                TextSize = 13,
                Font = Enum.Font.GothamMedium,
                TextXAlignment = "Left"
            })
            
            local ToggleBtn = Create("TextButton", {
                Name = "ToggleBtn",
                Parent = Toggle,
                Size = UDim2.new(0, 48, 0, 24),
                Position = UDim2.new(1, -54, 0.5, -12),
                BackgroundColor3 = Color3.fromRGB(60, 40, 80),
                Text = "",
                AutoButtonColor = true,
                BorderSizePixel = 0
            })
            
            MakeCorner(ToggleBtn, 12)
            
            local Knob = Create("Frame", {
                Name = "Knob",
                Parent = ToggleBtn,
                Size = UDim2.new(0, 20, 0, 20),
                Position = UDim2.new(0, 2, 0.5, -10),
                BackgroundColor3 = Color3.fromRGB(255, 255, 255)
            })
            
            MakeCorner(Knob, 10)
            
            local function SetValue(val)
                if val then
                    QuickTween(Knob, {Position = UDim2.new(1, -22, 0.5, -10)})
                    QuickTween(Knob, {BackgroundColor3 = DClib.Themes[DClib.Theme].Accent})
                else
                    QuickTween(Knob, {Position = UDim2.new(0, 2, 0.5, -10)})
                    QuickTween(Knob, {BackgroundColor3 = Color3.fromRGB(255, 255, 255)})
                end
            end
            
            SetValue(default)
            
            ToggleBtn.MouseButton1Click:Connect(function()
                default = not default
                SetValue(default)
                callback(default)
            end)
            
            return {Set = SetValue, Get = function() return default end}
        end
        
        function Tab:AddSlider(config)
            local sliderName = config.Name or "Slider"
            local min = config.Min or 0
            local max = config.Max or 100
            local default = config.Default or 50
            local callback = config.Callback or function() end
            
            local Slider = Create("Frame", {
                Name = "Slider",
                Parent = PanelScroll,
                Size = UDim2.new(1, 0, 0, 45),
                BackgroundTransparency = 1
            })
            
            local Label = Create("TextLabel", {
                Name = "Label",
                Parent = Slider,
                Size = UDim2.new(1, -60, 0, 16),
                BackgroundTransparency = 1,
                Text = sliderName .. ": " .. tostring(default),
                TextColor3 = DClib.Themes[DClib.Theme].Text,
                TextSize = 12,
                Font = Enum.Font.GothamMedium,
                TextXAlignment = "Left"
            })
            
            local Bar = Create("Frame", {
                Name = "Bar",
                Parent = Slider,
                Size = UDim2.new(1, 0, 0, 6),
                Position = UDim2.new(0, 0, 1, -10),
                BackgroundColor3 = DClib.Themes[DClib.Theme].Stroke
            })
            
            MakeCorner(Bar, 3)
            
            local Fill = Create("Frame", {
                Name = "Fill",
                Parent = Bar,
                Size = UDim2.new(0.5, 0, 1, 0),
                BackgroundColor3 = DClib.Themes[DClib.Theme].Accent
            })
            
            MakeCorner(Fill, 3)
            
            local Knob = Create("Frame", {
                Name = "Knob",
                Parent = Bar,
                Size = UDim2.new(0, 14, 0, 14),
                Position = UDim2.new(0.5, -7, 0.5, -7),
                BackgroundColor3 = Color3.fromRGB(255, 255, 255)
            })
            
            MakeCorner(Knob, 7)
            
            local function UpdateValue(val)
                local pct = (val - min) / (max - min)
                Fill.Size = UDim2.new(pct, 0, 1, 0)
                Knob.Position = UDim2.new(pct, -7, 0.5, -7)
                Label.Text = sliderName .. ": " .. tostring(math.floor(val))
                callback(val)
            end
            
            local dragging = false
            Knob.InputBegan:Connect(function(input)
                if input.UserInputType == Enum.UserInputType.MouseButton1 then
                    dragging = true
                    local conn
                    conn = UserInputService.InputChanged:Connect(function(input)
                        if dragging then
                            local pos = Bar.AbsolutePosition.X
                            local width = Bar.AbsoluteSize.X
                            local x = math.clamp(input.Position.X - pos, 0, width)
                            local pct = x / width
                            local val = min + pct * (max - min)
                            UpdateValue(val)
                        end
                    end)
                    
                    UserInputService.InputEnded:Connect(function()
                        dragging = false
                        conn:Disconnect()
                    end)
                end
            end)
            
            UpdateValue(default)
            
            return {Set = UpdateValue, Get = function() return default end}
        end
        
        return Tab
    end
    
    -- AddMinimizeButton function
    function Window:AddMinimizeButton(config)
        local buttonConfig = config.Button or {}
        local cornerConfig = config.Corner or {}
        local strokeConfig = config.Stroke or {}
        
        local MinBtn = Create("ImageButton", {
            Name = "CustomMinimizeButton",
            Parent = TitleBar,
            Size = buttonConfig.Size or UDim2.new(0, 30, 0, 30),
            Position = buttonConfig.Position or UDim2.new(1, -78, 0.5, -15),
            BackgroundColor3 = buttonConfig.BackgroundColor3 or DClib.Themes[DClib.Theme].Background,
            BackgroundTransparency = buttonConfig.BackgroundTransparency or 0,
            Image = buttonConfig.Image or "rbxassetid://125965818173870",
            AutoButtonColor = false
        })
        
        -- Bo tròn button
        MakeCorner(MinBtn, cornerConfig.CornerRadius or 6)
        MakeStroke(MinBtn, strokeConfig.Color or DClib.Themes[DClib.Theme].Accent, strokeConfig.Thickness or 1)
        
        -- Hover effects
        MinBtn.MouseEnter:Connect(function()
            Tween(MinBtn, {BackgroundTransparency = 0.2}, 0.15)
        end)
        
        MinBtn.MouseLeave:Connect(function()
            Tween(MinBtn, {BackgroundTransparency = buttonConfig.BackgroundTransparency or 0}, 0.15)
        end)
        
        -- Toggle minimize
        MinBtn.MouseButton1Click:Connect(function()
            if minimized then
                Tween(MainFrame, {Size = UDim2.new(0, 400, 0, 400)}, 0.25)
                Tween(MainFrame, {Position = UDim2.new(0.5, -200, 0.5, -200)}, 0.25)
                minimized = false
            else
                Tween(MainFrame, {Size = UDim2.new(0, 400, 0, 60)}, 0.25)
                Tween(MainFrame, {Position = UDim2.new(0.5, -200, 0.5, -30)}, 0.25)
                minimized = true
            end
        end)
        
        return MinBtn
    end
    
    return Window
end

return DClib
